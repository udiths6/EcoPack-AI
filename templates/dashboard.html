<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPack AI - Analytics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.plot.ly/plotly-2.18.0.min.js"></script>
    <style>
        :root {
            --primary-green: #2ecc71;
            --primary-blue: #3498db;
            --primary-red: #e74c3c;
            --primary-purple: #9b59b6;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            margin-bottom: 1.5rem;
            border-left: 5px solid var(--primary-green);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .stat-card.blue { border-left-color: var(--primary-blue); }
        .stat-card.red { border-left-color: var(--primary-red); }
        .stat-card.purple { border-left-color: var(--primary-purple); }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-icon {
            font-size: 3rem;
            opacity: 0.2;
            position: absolute;
            right: 20px;
            top: 20px;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .btn-export {
            background: linear-gradient(135deg, var(--primary-green) 0%, #27ae60 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        
        .icon-green { color: var(--primary-green); }
        .icon-blue { color: var(--primary-blue); }
        .icon-red { color: var(--primary-red); }
        .icon-purple { color: var(--primary-purple); }
    </style>
</head>
<body>
    
    <!-- Navigation -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-graph-up me-2"></i>EcoPack AI - Analytics Dashboard
            </span>
            <div>
                <button class="btn btn-light btn-sm me-2" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                </button>
                <a href="/" class="btn btn-light btn-sm">
                    <i class="bi bi-house me-1"></i>Home
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        
        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading analytics...</p>
        </div>

        <!-- No Data State -->
        <div id="noDataState" class="text-center py-5" style="display: none;">
            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
            <h4 class="text-muted">No Data Available</h4>
            <p class="text-muted">Make some recommendations first to see analytics!</p>
            <a href="/" class="btn btn-success">Go to Recommendations</a>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" style="display: none;">
            
            <!-- Export Buttons -->
            <div class="row mb-4">
                <div class="col-12 text-end">
                    <button class="btn btn-export me-2" onclick="exportPDF()">
                        <i class="bi bi-file-pdf me-2"></i>Export PDF Report
                    </button>
                    <button class="btn btn-export" onclick="exportExcel()">
                        <i class="bi bi-file-excel me-2"></i>Export Excel Data
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="row">
                <!-- Total Recommendations -->
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card position-relative">
                        <i class="bi bi-stack stat-icon icon-green"></i>
                        <div class="stat-label">Total Recommendations</div>
                        <div class="stat-value text-success" id="totalRecs">0</div>
                    </div>
                </div>

                <!-- CO2 Reduction -->
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card blue position-relative">
                        <i class="bi bi-leaf stat-icon icon-blue"></i>
                        <div class="stat-label">CO₂ Reduction</div>
                        <div class="stat-value text-primary" id="co2Reduction">0%</div>
                        <small class="text-muted" id="totalCO2Saved"></small>
                    </div>
                </div>

                <!-- Cost Savings -->
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card red position-relative">
                        <i class="bi bi-piggy-bank stat-icon icon-red"></i>
                        <div class="stat-label">Cost Savings</div>
                        <div class="stat-value text-danger" id="costSavings">$0</div>
                        <small class="text-muted" id="costSavingsPercent"></small>
                    </div>
                </div>

                <!-- Eco-Friendly % -->
                <div class="col-lg-3 col-md-6">
                    <div class="stat-card purple position-relative">
                        <i class="bi bi-recycle stat-icon icon-purple"></i>
                        <div class="stat-label">Eco-Friendly Materials</div>
                        <div class="stat-value text-purple" id="ecoPercent">0%</div>
                        <small class="text-muted" id="uniqueMaterials"></small>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-bar-chart text-success me-2"></i>Material Usage Distribution</h5>
                        <div id="materialUsageChart"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-pie-chart text-primary me-2"></i>Eco-Friendly Distribution</h5>
                        <div id="ecoDistributionChart"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-graph-up text-success me-2"></i>CO₂ Reduction Trend</h5>
                        <div id="co2TrendChart"></div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-currency-dollar text-primary me-2"></i>Cost Savings Trend</h5>
                        <div id="costSavingsTrendChart"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 3 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-trophy text-warning me-2"></i>Top Materials by Suitability Score</h5>
                        <div id="topMaterialsChart"></div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 4 -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="chart-container">
                        <h5 class="mb-3"><i class="bi bi-box-seam text-info me-2"></i>Category Comparison</h5>
                        <div id="categoryComparisonChart"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = '';

        // Load dashboard on page load
        window.addEventListener('load', () => {
            loadDashboard();
        });

        async function loadDashboard() {
            showLoading();

            try {
                // Fetch analytics data
                const analyticsResponse = await fetch(`${API_URL}/api/dashboard/analytics`);
                const analyticsData = await analyticsResponse.json();

                console.log('Analytics Response:', analyticsData);

                if (analyticsData.status === 'success' && analyticsData.data) {
                    // Fetch charts
                    const chartsResponse = await fetch(`${API_URL}/api/dashboard/charts`);
                    const chartsData = await chartsResponse.json();

                    console.log('Charts Response:', chartsData);

                    if (chartsData.status === 'success' && chartsData.data) {
                        displayDashboard(analyticsData.data, chartsData.data);
                    } else {
                        console.error('Charts error:', chartsData.message);
                        showNoData();
                    }
                } else {
                    console.error('Analytics error:', analyticsData.message);
                    showNoData();
                }

            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Error: ' + error.message + '. please try again.');
                showNoData();
            }
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('noDataState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function showNoData() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noDataState').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
        }

        function displayDashboard(analytics, chartsData) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('noDataState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Update summary cards
            const summary = analytics.summary_cards;
            document.getElementById('totalRecs').textContent = summary.total_recommendations;
            document.getElementById('co2Reduction').textContent = `${summary.co2_reduction_percent}%`;
            document.getElementById('totalCO2Saved').textContent = `${summary.total_co2_saved.toFixed(2)} units saved`;
            document.getElementById('costSavings').textContent = `$${summary.total_cost_saved.toFixed(2)}`;
            document.getElementById('costSavingsPercent').textContent = `${summary.cost_savings_percent.toFixed(1)}% reduction`;
            document.getElementById('ecoPercent').textContent = `${summary.eco_friendly_percentage}%`;
            document.getElementById('uniqueMaterials').textContent = `${summary.unique_materials_used} unique materials`;

            // Render charts using Plotly
            renderCharts(chartsData);
        }

        function renderCharts(data) {
            // Chart 1: Material Usage Bar Chart
            const materialUsageData = [{
                x: data.material_usage.labels,
                y: data.material_usage.values,
                type: 'bar',
                marker: {
                    color: '#2ecc71'
                },
                text: data.material_usage.values,
                textposition: 'auto'
            }];

            const materialUsageLayout = {
                title: 'Top 10 Most Recommended Materials',
                xaxis: { title: 'Material' },
                yaxis: { title: 'Number of Recommendations' },
                template: 'plotly_white',
                height: 400
            };

            Plotly.newPlot('materialUsageChart', materialUsageData, materialUsageLayout, {responsive: true});

            // Chart 2: Eco Distribution Pie Chart
            const ecoDistData = [{
                labels: data.eco_distribution.labels,
                values: data.eco_distribution.values,
                type: 'pie',
                marker: {
                    colors: ['#2ecc71', '#e74c3c']
                },
                hole: 0.3
            }];

            const ecoDistLayout = {
                title: 'Eco-Friendly Material Distribution',
                template: 'plotly_white',
                height: 400
            };

            Plotly.newPlot('ecoDistributionChart', ecoDistData, ecoDistLayout, {responsive: true});

            // Chart 3: CO2 Reduction Trend
            const co2TrendData = [{
                x: data.co2_trend.dates,
                y: data.co2_trend.values,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'CO2 Reduction %',
                line: {
                    color: '#27ae60',
                    width: 3
                },
                marker: { size: 8 }
            }];

            const co2TrendLayout = {
                title: 'CO₂ Reduction Trend Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'CO₂ Reduction %' },
                template: 'plotly_white',
                height: 400,
                shapes: [{
                    type: 'line',
                    x0: data.co2_trend.dates[0],
                    x1: data.co2_trend.dates[data.co2_trend.dates.length - 1],
                    y0: 0,
                    y1: 0,
                    line: {
                        color: 'gray',
                        dash: 'dash',
                        width: 2
                    }
                }]
            };

            Plotly.newPlot('co2TrendChart', co2TrendData, co2TrendLayout, {responsive: true});

            // Chart 4: Cost Savings Trend
            const costTrendData = [{
                x: data.cost_trend.dates,
                y: data.cost_trend.values,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Cost Savings',
                fill: 'tozeroy',
                fillcolor: 'rgba(52, 152, 219, 0.2)',
                line: {
                    color: '#3498db',
                    width: 3
                },
                marker: { size: 8 }
            }];

            const costTrendLayout = {
                title: 'Cost Savings Trend Over Time',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Cost Savings ($)' },
                template: 'plotly_white',
                height: 400
            };

            Plotly.newPlot('costSavingsTrendChart', costTrendData, costTrendLayout, {responsive: true});

            // Chart 5: Top Materials Ranking (Horizontal Bar)
            const topMaterialsData = [{
                y: data.top_materials.labels,
                x: data.top_materials.values,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#9b59b6'
                },
                text: data.top_materials.values.map(v => v.toFixed(1) + '%'),
                textposition: 'auto'
            }];

            const topMaterialsLayout = {
                title: 'Top 10 Materials by Average Suitability Score',
                xaxis: { title: 'Average Suitability Score (%)' },
                yaxis: { title: 'Material' },
                template: 'plotly_white',
                height: 500
            };

            Plotly.newPlot('topMaterialsChart', topMaterialsData, topMaterialsLayout, {responsive: true});

            // Chart 6: Category Comparison
            const categoryCompData = [
                {
                    x: data.category_comparison.categories,
                    y: data.category_comparison.co2_values,
                    name: 'Avg CO2',
                    type: 'bar',
                    marker: { color: '#e74c3c' }
                },
                {
                    x: data.category_comparison.categories,
                    y: data.category_comparison.cost_values,
                    name: 'Avg Cost',
                    type: 'bar',
                    marker: { color: '#3498db' }
                }
            ];

            const categoryCompLayout = {
                title: 'Average CO2 and Cost by Product Category',
                xaxis: { title: 'Category' },
                yaxis: { title: 'Value' },
                barmode: 'group',
                template: 'plotly_white',
                height: 400
            };

            Plotly.newPlot('categoryComparisonChart', categoryCompData, categoryCompLayout, {responsive: true});
        }

        function refreshDashboard() {
            loadDashboard();
        }

        async function exportPDF() {
            try {
                const response = await fetch(`${API_URL}/api/export/pdf`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sustainability_report_${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('PDF report downloaded successfully!');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                alert('Failed to export PDF report');
            }
        }

        async function exportExcel() {
            try {
                const response = await fetch(`${API_URL}/api/export/excel`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recommendations_data_${new Date().toISOString().slice(0,10)}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert('Excel file downloaded successfully!');
            } catch (error) {
                console.error('Error exporting Excel:', error);
                alert('Failed to export Excel file');
            }
        }
    </script>
</body>
</html>
